import fs from 'fs';
import { toImage, toImageBuffer, resizeImage } from '../src/common/utils';
import { expectError } from './utils';

describe('utils', () => {
  describe('resizeImage', () => {
    test('resizeImage - success jpg', async () => {
      let img = await toImage('/opt/app/tests/data/large.jpg');
      img = await resizeImage(img, 2000);
      expect(img.dimensions.width).toBe(1920);
      expect(img.dimensions.height).toBe(1080);
    });
    test('resizeImage - success png', async () => {
      let img = await toImage('/opt/app/tests/data/large.png');
      img = await resizeImage(img, 1000);
      expect(img.dimensions.width).toBe(1000);
      expect(img.dimensions.height).toBe(750);
    });
  });
  describe('toImage', () => {
    test('toImage - success jpg', async () => {
      const img = await toImage('/opt/app/tests/data/large.jpg');
      expect(typeof img).toBe('object');
      expect(img.dimensions.width).toBe(1920);
      expect(img.dimensions.height).toBe(1080);
    });
    test('toImage buffer - success jpg', async () => {
      const buffer = fs.readFileSync('/opt/app/tests/data/large.jpg');
      const img = await toImageBuffer(buffer, 'image/jpeg');

      expect(typeof img).toBe('object');
      expect(img.dimensions.width).toBe(1920);
      expect(img.dimensions.height).toBe(1080);
    });

    test('toImage buffer - fails gif', async () => {
      const buffer = fs.readFileSync('/opt/app/tests/data/large.jpg');
      await toImageBuffer(buffer, 'image/gif').catch(e =>
        expectError(e, {
          type: 'UnsupportedPhotoError',
          message: 'Unsupported image:image/gif'
        })
      );
    });

    test('toImage - success png', async () => {
      const img = await toImage('/opt/app/tests/data/large.png');
      expect(typeof img).toBe('object');
      expect(img.dimensions.width).toBe(2560);
      expect(img.dimensions.height).toBe(1920);
    });

    test('toImage - fails gif', async () => {
      await toImage('/opt/app/tests/data/large.gif').catch(e =>
        expectError(e, {
          type: 'UnsupportedPhotoError',
          message: 'Unsupported image:image/gif'
        })
      );
    });
    test('toImage - fails txt', async () => {
      await toImage('/opt/app/tests/data/hello.txt').catch(e =>
        expectError(e, {
          type: 'UnsupportedPhotoError',
          message: 'Unsupported image:text/plain'
        })
      );
    });
    test('toImage - fails missing file', async () => {
      await toImage('/opt/app/tests/data/hello2.txt').catch(e =>
        expectError(e, {
          message: '/opt/app/tests/data/hello2.txt does not exist.',
          type: 'UnsupportedPhotoError'
        })
      );
    });
  });
});
